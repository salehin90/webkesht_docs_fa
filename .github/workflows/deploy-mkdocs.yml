# Ù†Ø§Ù… Workflow Ú©Ù‡ Ø¯Ø± ØªØ¨ Actions Ú¯ÛŒØªâ€ŒÙ‡Ø§Ø¨ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
name: Deploy MkDocs to IIS - Enhanced Version V2

# ØªØ±ÛŒÚ¯Ø±: Ø§ÛŒÙ† Workflow Ú†Ù‡ Ø²Ù…Ø§Ù†ÛŒ Ø§Ø¬Ø±Ø§ Ø´ÙˆØ¯ØŸ
# Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ØŒ Ù‡Ø± Ø²Ù…Ø§Ù† Ú©Ù‡ Ú©Ø¯ÛŒ Ø¨Ù‡ Ø¨Ø±Ù†Ú† main Ù¾ÙˆØ´ Ø´ÙˆØ¯
on:
  push:
    branches:
      - main  # ÛŒØ§ masterØŒ Ø¨Ø³ØªÙ‡ Ø¨Ù‡ Ù†Ø§Ù… Ø¨Ø±Ù†Ú† Ø§ØµÙ„ÛŒ Ø´Ù…Ø§

# ØªØ¹Ø±ÛŒÙ Ú©Ø§Ø±Ù‡Ø§ (Jobs)
jobs:
  build-and-deploy:
    # Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ Job
    name: Build and Deploy MkDocs Site Enhanced V2

    # Ù…Ù‡Ù…: Ù…Ø´Ø®Øµ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ú©Ù‡ Ø§ÛŒÙ† Job Ø¨Ø§ÛŒØ¯ Ø±ÙˆÛŒ Runner Ø´Ø®ØµÛŒ Ù…Ø§ Ø§Ø¬Ø±Ø§ Ø´ÙˆØ¯
    runs-on: self-hosted

    # Ù…Ø±Ø§Ø­Ù„ Ø§Ø¬Ø±Ø§ÛŒ Job
    steps:
      # Ù…Ø±Ø­Ù„Ù‡ 1: Ø¯Ø±ÛŒØ§ÙØª Ø¢Ø®Ø±ÛŒÙ† Ù†Ø³Ø®Ù‡ Ú©Ø¯ Ø§Ø² Ø±ÛŒÙ¾Ø§Ø²ÛŒØªÙˆØ±ÛŒ
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Ù…Ø±Ø­Ù„Ù‡ 2: Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø­ÛŒØ· Ùˆ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ
      - name: Environment Check & Preparation
        shell: powershell
        run: |
          Write-Host "=== Environment Check ==="
          Set-Location "${{ github.workspace }}"
          Write-Host "Current directory: $(Get-Location)"
          
          # Ø¨Ø±Ø±Ø³ÛŒ ÙØ§ÛŒÙ„ mkdocs.yml
          if (Test-Path "mkdocs.yml") {
            Write-Host "âœ… mkdocs.yml found"
          } else {
            Write-Host "âŒ mkdocs.yml not found!"
            exit 1
          }
          
          # Ø¨Ø±Ø±Ø³ÛŒ Ùˆ Ø§ÛŒØ¬Ø§Ø¯ Ù¾ÙˆØ´Ù‡â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø²
          $requiredDirs = @("docs", "overrides", "stylesheets")
          foreach ($dir in $requiredDirs) {
            if (-not (Test-Path $dir)) {
              Write-Host "Creating missing directory: $dir"
              New-Item -ItemType Directory -Name $dir -Force
              
              # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø²
              if ($dir -eq "docs" -and -not (Test-Path "docs\index.md")) {
                "# Welcome`n`nThis is the homepage." | Out-File -FilePath "docs\index.md" -Encoding UTF8
              }
              if ($dir -eq "stylesheets" -and -not (Test-Path "stylesheets\custom.css")) {
                "/* Custom CSS */" | Out-File -FilePath "stylesheets\custom.css" -Encoding UTF8
              }
            } else {
              Write-Host "âœ… Directory exists: $dir"
            }
          }

      # Ù…Ø±Ø­Ù„Ù‡ 3: ØªØ³Øª MkDocs Ù‚Ø¨Ù„ Ø§Ø² Ø¨ÛŒÙ„Ø¯ Ø§ØµÙ„ÛŒ - Ù†Ø³Ø®Ù‡ Ø¨Ù‡Ø¨ÙˆØ¯ ÛŒØ§ÙØªÙ‡
      - name: Test MkDocs Configuration
        shell: powershell
        run: |
          Set-Location "${{ github.workspace }}"
          
          Write-Host "=== Testing MkDocs Configuration ==="
          
          # ØªØ³Øª version
          Write-Host "MkDocs version:"
          python -m mkdocs --version
          
          # ØªØ³Øª Ø³Ø§Ø¯Ù‡â€ŒØªØ± Ø¨Ø¯ÙˆÙ† PyYAML - ÙÙ‚Ø· Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ MkDocs
          Write-Host "`nTesting MkDocs configuration directly..."
          
          try {
            # Ø¨Ø¬Ø§ÛŒ Ù¾Ø§Ø±Ø³ Ú©Ø±Ø¯Ù† YAML Ø®ÙˆØ¯Ù…Ø§Ù†ØŒ Ø§Ø² Ø®ÙˆØ¯ MkDocs Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
            Write-Host "Testing MkDocs config validation..."
            python -m mkdocs config
            
            if ($LASTEXITCODE -eq 0) {
              Write-Host "âœ… MkDocs configuration is valid!"
            } else {
              Write-Host "âš ï¸  MkDocs config validation returned non-zero code but continuing..."
            }
            
            # ØªØ³Øª Ø§Ø¶Ø§ÙÛŒ: Ø¨Ø±Ø±Ø³ÛŒ syntax
            Write-Host "`nTesting configuration syntax with MkDocs serve (dry-run)..."
            $testResult = python -m mkdocs serve --help 2>&1
            Write-Host "âœ… MkDocs commands are accessible"
            
          } catch {
            Write-Host "âš ï¸  Configuration test warning: $($_.Exception.Message)"
            Write-Host "Continuing with build process..."
          }

      # Ù…Ø±Ø­Ù„Ù‡ 4: Ø¨ÛŒÙ„Ø¯ Ú©Ø±Ø¯Ù† Ø³Ø§ÛŒØª Ø¨Ø§ Ø¯Ø³ØªÙˆØ± mkdocs build
      - name: Build MkDocs Site
        shell: powershell
        run: |
          Set-Location "${{ github.workspace }}"
          
          Write-Host "=== Building MkDocs Site ==="
          
          # ØªÙ†Ø¸ÛŒÙ… environment variables Ø¨Ø±Ø§ÛŒ UTF-8
          $env:PYTHONIOENCODING = "utf-8"
          $env:LANG = "en_US.UTF-8"
          
          # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ø¶Ø§ÙÛŒ Ø¨Ø±Ø§ÛŒ materialx
          $env:PYTHONPATH = "$env:PYTHONPATH;C:\Python313\Lib\site-packages"
          
          Write-Host "Running: python -m mkdocs build --clean --verbose"
          python -m mkdocs build --clean --verbose
          
          $buildExitCode = $LASTEXITCODE
          Write-Host "Build exit code: $buildExitCode"
          
          if ($buildExitCode -eq 0) {
            Write-Host "âœ… Build successful!"
            
            # Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯Ù† ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ
            if (Test-Path "site") {
              $siteFiles = Get-ChildItem -Path "site" -Recurse -File
              Write-Host "Generated files count: $($siteFiles.Count)"
              
              # Ù†Ù…Ø§ÛŒØ´ Ø³Ø§Ø®ØªØ§Ø± ÙØ§ÛŒÙ„ Ø¨Ø±Ø§ÛŒ debug
              Write-Host "`nSite directory structure:"
              Get-ChildItem -Path "site" -Directory | ForEach-Object { 
                Write-Host "  ğŸ“ $($_.Name)" 
              }
              
              # ØªØ´Ø®ÛŒØµ Ù…Ø³ÛŒØ± ØµØ­ÛŒØ­ source
              if (Test-Path "site\fa") {
                Write-Host "âœ… FA-specific build directory found: site\fa"
                $global:SourcePath = "site\fa"
              } elseif (Test-Path "site\ar") {
                Write-Host "âœ… AR-specific build directory found: site\ar"
                $global:SourcePath = "site\ar"
              } else {
                Write-Host "âœ… Using main site directory: site"
                $global:SourcePath = "site"
              }
            } else {
              Write-Host "âŒ Site directory not created!"
              
              # Debug: Ù†Ù…Ø§ÛŒØ´ Ù…Ø­ØªÙˆÛŒØ§Øª Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒ ÙØ¹Ù„ÛŒ
              Write-Host "`nCurrent directory contents:"
              Get-ChildItem | ForEach-Object { Write-Host "  $($_.Name)" }
              exit 1
            }
          } else {
            Write-Host "âŒ Build failed!"
            Write-Host "`nTrying to show more detailed error information..."
            
            # ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¬Ø²Ø¦ÛŒØ§Øª Ø¨ÛŒØ´ØªØ± Ø®Ø·Ø§
            try {
              python -m mkdocs build --verbose --strict 2>&1 | Write-Host
            } catch {
              Write-Host "Could not get detailed error info"
            }
            
            exit $buildExitCode
          }

      # Ù…Ø±Ø­Ù„Ù‡ 5: Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¯Ø± IIS
      - name: Smart Deploy to IIS
        shell: powershell
        run: |
          Write-Host "=== Smart IIS Deployment ==="
          
          # ØªÙ†Ø¸ÛŒÙ… Ù…Ø³ÛŒØ±Ù‡Ø§
          $targetPath = "C:\inetpub\wwwroot\webkesht_docs"
          
          # ØªØ´Ø®ÛŒØµ Ù…Ø³ÛŒØ± ØµØ­ÛŒØ­ source Ø¨Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ø¨ÛŒØ´ØªØ±
          $sourcePath = ""
          $possiblePaths = @(
            "${{ github.workspace }}\site\fa",
            "${{ github.workspace }}\site\ar", 
            "${{ github.workspace }}\site"
          )
          
          foreach ($path in $possiblePaths) {
            if (Test-Path $path) {
              $sourcePath = $path
              Write-Host "âœ… Using build directory: $sourcePath"
              break
            }
          }
          
          if (-not $sourcePath) {
            Write-Host "âŒ No valid source directory found!"
            Write-Host "Checked paths:"
            foreach ($path in $possiblePaths) {
              Write-Host "  - $path ($(if (Test-Path $path) {'EXISTS'} else {'NOT FOUND'}))"
            }
            exit 1
          }

          Write-Host "Deploying from '$sourcePath' to '$targetPath'..."

          # === Ù…Ø±Ø­Ù„Ù‡ 1: Ù…Ø¯ÛŒØ±ÛŒØª IIS (Ø§Ø®ØªÛŒØ§Ø±ÛŒ) ===
          Write-Host "`n--- IIS Management (Optional) ---"
          try {
            Import-Module WebAdministration -ErrorAction SilentlyContinue
            
            $appPoolName = "webkesht_docs"
            $appPool = Get-IISAppPool -Name $appPoolName -ErrorAction SilentlyContinue
            
            if ($appPool) {
              Write-Host "Stopping Application Pool: $appPoolName"
              Stop-WebAppPool -Name $appPoolName -ErrorAction SilentlyContinue
              Start-Sleep -Seconds 5
              Write-Host "âœ… Application Pool stopped"
            } else {
              Write-Host "âš ï¸  Application Pool '$appPoolName' not found - continuing without IIS management"
            }
          } catch {
            Write-Host "âš ï¸  IIS management skipped: $($_.Exception.Message)"
          }

          # === Ù…Ø±Ø­Ù„Ù‡ 2: Ø§ÛŒØ¬Ø§Ø¯ Ùˆ ØªÙ†Ø¸ÛŒÙ… Ù…Ø¬ÙˆØ²Ù‡Ø§ÛŒ Ù¾ÙˆØ´Ù‡ Ù…Ù‚ØµØ¯ ===
          Write-Host "`n--- Target Directory Management ---"
          if (-not (Test-Path $targetPath)) {
            Write-Host "Creating target directory..."
            New-Item -ItemType Directory -Force -Path $targetPath
          }
          
          # ØªÙ†Ø¸ÛŒÙ… Ù…Ø¬ÙˆØ²Ù‡Ø§
          try {
            $currentUser = [System.Security.Principal.WindowsIdentity]::GetCurrent().Name
            icacls $targetPath /grant "${currentUser}:(OI)(CI)F" /T /C /Q
            icacls $targetPath /grant "IIS_IUSRS:(OI)(CI)F" /T /C /Q
            Write-Host "âœ… Permissions set for $currentUser and IIS_IUSRS"
          } catch {
            Write-Host "âš ï¸  Permission warning: $($_.Exception.Message)"
          }

          # === Ù…Ø±Ø­Ù„Ù‡ 3: Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯ ===
          Write-Host "`n--- Smart Cleanup ---"
          if (Test-Path $targetPath) {
            try {
              # Ù…Ø­Ø§ÙØ¸Øª Ø§Ø² ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…Ù‡Ù… Ø³ÛŒØ³ØªÙ… (Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ù†Ø¯)
              $protectedFiles = @("web.config", ".htaccess", "robots.txt", "favicon.ico")
              $backupPath = "$env:TEMP\iis_backup_$(Get-Date -Format 'yyyyMMdd_HHmmss')"
              
              # Ø¨Ú©Ø§Ù¾ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…Ø­Ø§ÙØ¸Øª Ø´Ø¯Ù‡
              $backedUpFiles = @()
              foreach ($protectedFile in $protectedFiles) {
                $filePath = Join-Path $targetPath $protectedFile
                if (Test-Path $filePath) {
                  if (-not (Test-Path $backupPath)) {
                    New-Item -ItemType Directory -Force -Path $backupPath
                  }
                  Copy-Item $filePath "$backupPath\$protectedFile" -Force
                  $backedUpFiles += $protectedFile
                  Write-Host "Backed up: $protectedFile"
                }
              }
              
              # Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ø¨Ø§ retry mechanism
              $maxRetries = 3
              $retryCount = 0
              $cleanSuccess = $false
              
              while ($retryCount -lt $maxRetries -and -not $cleanSuccess) {
                try {
                  Get-ChildItem -Path $targetPath -Recurse -Force | 
                    Where-Object { $_.FullName -notlike "*backup*" } |
                    Remove-Item -Force -Recurse -ErrorAction Stop
                  $cleanSuccess = $true
                  Write-Host "âœ… Directory cleaned successfully"
                } catch {
                  $retryCount++
                  Write-Host "Cleanup retry $retryCount/$maxRetries... ($($_.Exception.Message))"
                  Start-Sleep -Seconds 3
                }
              }
              
              if (-not $cleanSuccess) {
                Write-Host "âš ï¸  Could not fully clean directory, but continuing..."
              }
              
              # Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…Ø­Ø§ÙØ¸Øª Ø´Ø¯Ù‡
              if ((Test-Path $backupPath) -and ($backedUpFiles.Count -gt 0)) {
                Copy-Item "$backupPath\*" $targetPath -Force -ErrorAction SilentlyContinue
                Remove-Item $backupPath -Recurse -Force -ErrorAction SilentlyContinue
                Write-Host "Protected files restored: $($backedUpFiles -join ', ')"
              }
              
            } catch {
              Write-Host "âš ï¸  Cleanup warning: $($_.Exception.Message)"
            }
          }

          # === Ù…Ø±Ø­Ù„Ù‡ 4: Ú©Ù¾ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¨Ø§ ROBOCOPY ===
          Write-Host "`n--- Smart Copy with ROBOCOPY ---"
          $copySuccess = $false
          
          try {
            $robocopyArgs = @(
              "`"$sourcePath`"",
              "`"$targetPath`"",
              "/E",           # Ú©Ù¾ÛŒ subdirectories
              "/R:2",         # 2 retry
              "/W:3",         # 3 second wait
              "/MT:2",        # multi-threaded
              "/XO",          # exclude older files
              "/NFL",         # no file list
              "/NDL"          # no directory list
            )
            
            $robocopyCmd = "robocopy " + ($robocopyArgs -join " ")
            Write-Host "Running: $robocopyCmd"
            
            & cmd.exe /c $robocopyCmd
            $robocopyExitCode = $LASTEXITCODE
            
            # ROBOCOPY success codes: 0-7 are typically successful
            if ($robocopyExitCode -le 7) {
              Write-Host "âœ… ROBOCOPY completed successfully (exit code: $robocopyExitCode)"
              $copySuccess = $true
            } else {
              throw "ROBOCOPY failed with exit code: $robocopyExitCode"
            }
          } catch {
            Write-Host "âš ï¸  ROBOCOPY failed: $($_.Exception.Message)"
            Write-Host "Falling back to PowerShell copy..."
            
            try {
              Copy-Item -Path "$sourcePath\*" -Destination $targetPath -Recurse -Force
              Write-Host "âœ… PowerShell copy succeeded"
              $copySuccess = $true
            } catch {
              Write-Host "âŒ All copy methods failed: $($_.Exception.Message)"
              exit 1
            }
          }

          # === Ù…Ø±Ø­Ù„Ù‡ 5: Ø¨Ø±Ø±Ø³ÛŒ Ù†ØªÛŒØ¬Ù‡ ===
          Write-Host "`n--- Deployment Verification ---"
          if ($copySuccess) {
            try {
              $deployedFiles = Get-ChildItem -Path $targetPath -Recurse -File
              Write-Host "âœ… Deployment successful!"
              Write-Host "Total files deployed: $($deployedFiles.Count)"
              
              # Ø¨Ø±Ø±Ø³ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ú©Ù„ÛŒØ¯ÛŒ
              $keyFiles = @("index.html", "404.html")
              foreach ($keyFile in $keyFiles) {
                $keyFilePath = Join-Path $targetPath $keyFile
                if (Test-Path $keyFilePath) {
                  $fileSize = (Get-Item $keyFilePath).Length
                  Write-Host "âœ… Key file exists: $keyFile ($fileSize bytes)"
                } else {
                  Write-Host "âš ï¸  Key file missing: $keyFile"
                }
              }
              
              # Ù†Ù…Ø§ÛŒØ´ Ø³Ø§Ø®ØªØ§Ø± Ú©Ù„ÛŒ
              Write-Host "`nDeployed directory structure:"
              Get-ChildItem -Path $targetPath -Directory | Select-Object -First 10 | ForEach-Object { 
                Write-Host "  ğŸ“ $($_.Name)" 
              }
              
            } catch {
              Write-Host "âš ï¸  Verification warning: $($_.Exception.Message)"
            }
          }

          # === Ù…Ø±Ø­Ù„Ù‡ 6: Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù…Ø¬Ø¯Ø¯ IIS ===
          Write-Host "`n--- Restart IIS Services ---"
          try {
            if ($appPool) {
              Write-Host "Starting Application Pool: $appPoolName"
              Start-WebAppPool -Name $appPoolName -ErrorAction SilentlyContinue
              Start-Sleep -Seconds 3
              
              # Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª App Pool
              $appPoolState = (Get-WebAppPoolState -Name $appPoolName).Value
              Write-Host "Application Pool state: $appPoolState"
              Write-Host "âœ… Application Pool management completed"
            }
          } catch {
            Write-Host "âš ï¸  IIS restart warning: $($_.Exception.Message)"
          }
          
          Write-Host "`nğŸ‰ Smart deployment completed successfully!"
          Write-Host "Site should be available at your configured IIS endpoint"
