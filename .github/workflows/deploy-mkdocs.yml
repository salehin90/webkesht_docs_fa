# Ù†Ø§Ù… Workflow Ú©Ù‡ Ø¯Ø± ØªØ¨ Actions Ú¯ÛŒØªâ€ŒÙ‡Ø§Ø¨ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
name: Deploy MkDocs to IIS - Enhanced Version

# ØªØ±ÛŒÚ¯Ø±: Ø§ÛŒÙ† Workflow Ú†Ù‡ Ø²Ù…Ø§Ù†ÛŒ Ø§Ø¬Ø±Ø§ Ø´ÙˆØ¯ØŸ
# Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ØŒ Ù‡Ø± Ø²Ù…Ø§Ù† Ú©Ù‡ Ú©Ø¯ÛŒ Ø¨Ù‡ Ø¨Ø±Ù†Ú† main Ù¾ÙˆØ´ Ø´ÙˆØ¯
on:
  push:
    branches:
      - main  # ÛŒØ§ masterØŒ Ø¨Ø³ØªÙ‡ Ø¨Ù‡ Ù†Ø§Ù… Ø¨Ø±Ù†Ú† Ø§ØµÙ„ÛŒ Ø´Ù…Ø§

# ØªØ¹Ø±ÛŒÙ Ú©Ø§Ø±Ù‡Ø§ (Jobs)
jobs:
  build-and-deploy:
    # Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ Job
    name: Build and Deploy MkDocs Site Enhanced

    # Ù…Ù‡Ù…: Ù…Ø´Ø®Øµ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ú©Ù‡ Ø§ÛŒÙ† Job Ø¨Ø§ÛŒØ¯ Ø±ÙˆÛŒ Runner Ø´Ø®ØµÛŒ Ù…Ø§ Ø§Ø¬Ø±Ø§ Ø´ÙˆØ¯
    runs-on: self-hosted

    # Ù…Ø±Ø§Ø­Ù„ Ø§Ø¬Ø±Ø§ÛŒ Job
    steps:
      # Ù…Ø±Ø­Ù„Ù‡ 1: Ø¯Ø±ÛŒØ§ÙØª Ø¢Ø®Ø±ÛŒÙ† Ù†Ø³Ø®Ù‡ Ú©Ø¯ Ø§Ø² Ø±ÛŒÙ¾Ø§Ø²ÛŒØªÙˆØ±ÛŒ
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Ù…Ø±Ø­Ù„Ù‡ 2: Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø­ÛŒØ· Ùˆ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ
      - name: Environment Check & Preparation
        shell: powershell
        run: |
          Write-Host "=== Environment Check ==="
          Set-Location "${{ github.workspace }}"
          Write-Host "Current directory: $(Get-Location)"
          
          # Ø¨Ø±Ø±Ø³ÛŒ ÙØ§ÛŒÙ„ mkdocs.yml
          if (Test-Path "mkdocs.yml") {
            Write-Host "âœ… mkdocs.yml found"
          } else {
            Write-Host "âŒ mkdocs.yml not found!"
            exit 1
          }
          
          # Ø¨Ø±Ø±Ø³ÛŒ Ùˆ Ø§ÛŒØ¬Ø§Ø¯ Ù¾ÙˆØ´Ù‡â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø²
          $requiredDirs = @("docs", "overrides", "stylesheets")
          foreach ($dir in $requiredDirs) {
            if (-not (Test-Path $dir)) {
              Write-Host "Creating missing directory: $dir"
              New-Item -ItemType Directory -Name $dir -Force
              
              # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø²
              if ($dir -eq "docs" -and -not (Test-Path "docs\index.md")) {
                "# Welcome`n`nThis is the homepage." | Out-File -FilePath "docs\index.md" -Encoding UTF8
              }
              if ($dir -eq "stylesheets" -and -not (Test-Path "stylesheets\custom.css")) {
                "/* Custom CSS */" | Out-File -FilePath "stylesheets\custom.css" -Encoding UTF8
              }
            } else {
              Write-Host "âœ… Directory exists: $dir"
            }
          }

      # Ù…Ø±Ø­Ù„Ù‡ 3: ØªØ³Øª MkDocs Ù‚Ø¨Ù„ Ø§Ø² Ø¨ÛŒÙ„Ø¯ Ø§ØµÙ„ÛŒ
      - name: Test MkDocs Configuration
        shell: powershell
        run: |
          Set-Location "${{ github.workspace }}"
          
          Write-Host "=== Testing MkDocs Configuration ==="
          
          # ØªØ³Øª version
          Write-Host "MkDocs version:"
          python -m mkdocs --version
          
          # ØªØ³Øª YAML parsing
          Write-Host "`nTesting YAML configuration parsing..."
          
          # Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø¯ Ù¾Ø§ÛŒØªÙˆÙ† Ø¨Ø§ Ø®Ø·ÙˆØ· Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡
          $pythonCode = 'import yaml' + "`n"
          $pythonCode += 'import sys' + "`n"
          $pythonCode += 'sys.stdout.reconfigure(encoding="utf-8")' + "`n"
          $pythonCode += 'with open("mkdocs.yml", "r", encoding="utf-8") as f:' + "`n"
          $pythonCode += '    config = yaml.safe_load(f)' + "`n"
          $pythonCode += '    print("âœ… YAML parsing successful!")' + "`n"
          $pythonCode += '    print("Site name:", config.get("site_name", "Not found"))' + "`n"
          $pythonCode += '    theme_info = config.get("theme", {})' + "`n"
          $pythonCode += '    if isinstance(theme_info, dict):' + "`n"
          $pythonCode += '        theme_name = theme_info.get("name", "Not found")' + "`n"
          $pythonCode += '    else:' + "`n"
          $pythonCode += '        theme_name = str(theme_info)' + "`n"
          $pythonCode += '    print("Theme:", theme_name)'
          
          $pythonCode | Out-File -FilePath "test_config.py" -Encoding UTF8
          python test_config.py
          Remove-Item "test_config.py" -ErrorAction SilentlyContinue
          
          if ($LASTEXITCODE -ne 0) {
            Write-Host "âŒ Configuration test failed!"
            exit $LASTEXITCODE
          }

      # Ù…Ø±Ø­Ù„Ù‡ 4: Ø¨ÛŒÙ„Ø¯ Ú©Ø±Ø¯Ù† Ø³Ø§ÛŒØª Ø¨Ø§ Ø¯Ø³ØªÙˆØ± mkdocs build
      - name: Build MkDocs Site
        shell: powershell
        run: |
          Set-Location "${{ github.workspace }}"
          
          Write-Host "=== Building MkDocs Site ==="
          
          # ØªÙ†Ø¸ÛŒÙ… environment variables Ø¨Ø±Ø§ÛŒ UTF-8
          $env:PYTHONIOENCODING = "utf-8"
          $env:LANG = "en_US.UTF-8"
          
          Write-Host "Running: python -m mkdocs build --clean --verbose"
          python -m mkdocs build --clean --verbose
          
          $buildExitCode = $LASTEXITCODE
          Write-Host "Build exit code: $buildExitCode"
          
          if ($buildExitCode -eq 0) {
            Write-Host "âœ… Build successful!"
            
            # Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯Ù† ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ
            if (Test-Path "site") {
              $siteFiles = Get-ChildItem -Path "site" -Recurse -File
              Write-Host "Generated files count: $($siteFiles.Count)"
              
              # ØªØ´Ø®ÛŒØµ Ù…Ø³ÛŒØ± ØµØ­ÛŒØ­ source
              if (Test-Path "site\fa") {
                Write-Host "âœ… FA-specific build directory found: site\fa"
                $global:SourcePath = "site\fa"
              } else {
                Write-Host "âœ… Using main site directory: site"
                $global:SourcePath = "site"
              }
            } else {
              Write-Host "âŒ Site directory not created!"
              exit 1
            }
          } else {
            Write-Host "âŒ Build failed!"
            exit $buildExitCode
          }

      # Ù…Ø±Ø­Ù„Ù‡ 5: Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¯Ø± IIS
      - name: Smart Deploy to IIS
        shell: powershell
        run: |
          Write-Host "=== Smart IIS Deployment ==="
          
          # ØªÙ†Ø¸ÛŒÙ… Ù…Ø³ÛŒØ±Ù‡Ø§
          $targetPath = "C:\inetpub\wwwroot\webkesht_docs"
          
          # ØªØ´Ø®ÛŒØµ Ù…Ø³ÛŒØ± ØµØ­ÛŒØ­ source
          if (Test-Path "${{ github.workspace }}\site\fa") {
            $sourcePath = "${{ github.workspace }}\site\fa"
            Write-Host "âœ… Using FA-specific build: $sourcePath"
          } else {
            $sourcePath = "${{ github.workspace }}\site"
            Write-Host "âœ… Using main site build: $sourcePath"
          }

          Write-Host "Deploying from '$sourcePath' to '$targetPath'..."

          # === Ù…Ø±Ø­Ù„Ù‡ 1: Ù…Ø¯ÛŒØ±ÛŒØª IIS (Ø§Ø®ØªÛŒØ§Ø±ÛŒ) ===
          Write-Host "`n--- IIS Management (Optional) ---"
          try {
            Import-Module WebAdministration -ErrorAction SilentlyContinue
            
            $appPoolName = "webkesht_docs"
            $appPool = Get-IISAppPool -Name $appPoolName -ErrorAction SilentlyContinue
            
            if ($appPool) {
              Write-Host "Stopping Application Pool: $appPoolName"
              Stop-WebAppPool -Name $appPoolName -ErrorAction SilentlyContinue
              Start-Sleep -Seconds 5
              Write-Host "âœ… Application Pool stopped"
            }
          } catch {
            Write-Host "âš ï¸  IIS management skipped: $($_.Exception.Message)"
          }

          # === Ù…Ø±Ø­Ù„Ù‡ 2: Ø§ÛŒØ¬Ø§Ø¯ Ùˆ ØªÙ†Ø¸ÛŒÙ… Ù…Ø¬ÙˆØ²Ù‡Ø§ÛŒ Ù¾ÙˆØ´Ù‡ Ù…Ù‚ØµØ¯ ===
          Write-Host "`n--- Target Directory Management ---"
          if (-not (Test-Path $targetPath)) {
            Write-Host "Creating target directory..."
            New-Item -ItemType Directory -Force -Path $targetPath
          }
          
          # ØªÙ†Ø¸ÛŒÙ… Ù…Ø¬ÙˆØ²Ù‡Ø§
          try {
            $currentUser = [System.Security.Principal.WindowsIdentity]::GetCurrent().Name
            icacls $targetPath /grant "${currentUser}:(OI)(CI)F" /T /C /Q
            icacls $targetPath /grant "IIS_IUSRS:(OI)(CI)F" /T /C /Q
            Write-Host "âœ… Permissions set"
          } catch {
            Write-Host "âš ï¸  Permission warning: $($_.Exception.Message)"
          }

          # === Ù…Ø±Ø­Ù„Ù‡ 3: Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯ ===
          Write-Host "`n--- Smart Cleanup ---"
          if (Test-Path $targetPath) {
            try {
              # Ù…Ø­Ø§ÙØ¸Øª Ø§Ø² ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…Ù‡Ù… Ø³ÛŒØ³ØªÙ… (Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ù†Ø¯)
              $protectedFiles = @("web.config", ".htaccess", "robots.txt")
              $backupPath = "$env:TEMP\iis_backup_$(Get-Date -Format 'yyyyMMdd_HHmmss')"
              
              # Ø¨Ú©Ø§Ù¾ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…Ø­Ø§ÙØ¸Øª Ø´Ø¯Ù‡
              foreach ($protectedFile in $protectedFiles) {
                $filePath = Join-Path $targetPath $protectedFile
                if (Test-Path $filePath) {
                  if (-not (Test-Path $backupPath)) {
                    New-Item -ItemType Directory -Force -Path $backupPath
                  }
                  Copy-Item $filePath "$backupPath\$protectedFile" -Force
                  Write-Host "Backed up: $protectedFile"
                }
              }
              
              # Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ø¨Ø§ retry mechanism
              $maxRetries = 3
              $retryCount = 0
              $cleanSuccess = $false
              
              while ($retryCount -lt $maxRetries -and -not $cleanSuccess) {
                try {
                  Get-ChildItem -Path $targetPath -Recurse -Force | 
                    Where-Object { $_.FullName -notlike "*backup*" } |
                    Remove-Item -Force -Recurse -ErrorAction Stop
                  $cleanSuccess = $true
                  Write-Host "âœ… Directory cleaned successfully"
                } catch {
                  $retryCount++
                  Write-Host "Cleanup retry $retryCount/$maxRetries..."
                  Start-Sleep -Seconds 2
                }
              }
              
              # Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…Ø­Ø§ÙØ¸Øª Ø´Ø¯Ù‡
              if (Test-Path $backupPath) {
                Copy-Item "$backupPath\*" $targetPath -Force -ErrorAction SilentlyContinue
                Remove-Item $backupPath -Recurse -Force -ErrorAction SilentlyContinue
                Write-Host "Protected files restored"
              }
              
            } catch {
              Write-Host "âš ï¸  Cleanup warning: $($_.Exception.Message)"
            }
          }

          # === Ù…Ø±Ø­Ù„Ù‡ 4: Ú©Ù¾ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¨Ø§ ROBOCOPY ===
          Write-Host "`n--- Smart Copy with ROBOCOPY ---"
          try {
            $robocopyArgs = @(
              "`"$sourcePath`"",
              "`"$targetPath`"",
              "/E",           # Ú©Ù¾ÛŒ subdirectories
              "/R:2",         # 2 retry
              "/W:3",         # 3 second wait
              "/MT:2",        # multi-threaded
              "/XO"           # exclude older files
            )
            
            $robocopyCmd = "robocopy " + ($robocopyArgs -join " ")
            Write-Host "Running: $robocopyCmd"
            
            & cmd.exe /c $robocopyCmd
            $robocopyExitCode = $LASTEXITCODE
            
            # ROBOCOPY success codes: 0-7 are typically successful
            if ($robocopyExitCode -le 7) {
              Write-Host "âœ… ROBOCOPY completed successfully (exit code: $robocopyExitCode)"
              $copySuccess = $true
            } else {
              throw "ROBOCOPY failed with exit code: $robocopyExitCode"
            }
          } catch {
            Write-Host "âš ï¸  ROBOCOPY failed: $($_.Exception.Message)"
            Write-Host "Falling back to PowerShell copy..."
            
            try {
              Copy-Item -Path "$sourcePath\*" -Destination $targetPath -Recurse -Force
              Write-Host "âœ… PowerShell copy succeeded"
              $copySuccess = $true
            } catch {
              Write-Host "âŒ All copy methods failed: $($_.Exception.Message)"
              exit 1
            }
          }

          # === Ù…Ø±Ø­Ù„Ù‡ 5: Ø¨Ø±Ø±Ø³ÛŒ Ù†ØªÛŒØ¬Ù‡ ===
          Write-Host "`n--- Deployment Verification ---"
          if ($copySuccess) {
            try {
              $deployedFiles = Get-ChildItem -Path $targetPath -Recurse -File
              Write-Host "âœ… Deployment successful!"
              Write-Host "Total files deployed: $($deployedFiles.Count)"
              
              # Ø¨Ø±Ø±Ø³ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ú©Ù„ÛŒØ¯ÛŒ
              $keyFiles = @("index.html")
              foreach ($keyFile in $keyFiles) {
                if (Test-Path (Join-Path $targetPath $keyFile)) {
                  Write-Host "âœ… Key file exists: $keyFile"
                } else {
                  Write-Host "âš ï¸  Key file missing: $keyFile"
                }
              }
            } catch {
              Write-Host "âš ï¸  Verification warning: $($_.Exception.Message)"
            }
          }

          # === Ù…Ø±Ø­Ù„Ù‡ 6: Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù…Ø¬Ø¯Ø¯ IIS ===
          Write-Host "`n--- Restart IIS Services ---"
          try {
            if ($appPool) {
              Write-Host "Starting Application Pool: $appPoolName"
              Start-WebAppPool -Name $appPoolName -ErrorAction SilentlyContinue
              Start-Sleep -Seconds 3
              Write-Host "âœ… Application Pool restarted"
            }
          } catch {
            Write-Host "âš ï¸  IIS restart warning: $($_.Exception.Message)"
          }
          
          Write-Host "`nğŸ‰ Smart deployment completed successfully!"
